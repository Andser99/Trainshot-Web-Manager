<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <style>
    html {
      min-height: 100%;
    }

    body {
      overflow: auto;
      background: rgb(32, 32, 32);
      background: linear-gradient(0deg, rgba(48, 48, 48, 1) 0%, rgba(14, 14, 14, 1) 43%, rgba(60, 60, 60, 1) 100%);
      padding: 0px;
      margin: 0px;
      font-family: sans-serif;
      font-size: 16px;
    }

    input,
    button {
      font-family: sans-serif;
      font-weight: 700;
    }

    .navbar {
      display: none;
      position: fixed;
      top: 0;
      width: 100%;
    }

    .main-div,
    .loggedin-div {
      width: 20%;
      margin: 0px auto;
      margin-top: 150px;
      padding: 20px;
      display: none;
    }

    .loggedin-div p,
    .loggedin-div h3 {
      color: #fff;
    }

    .main-div input {
      display: block;
      border: 1px solid #ccc;
      border-radius: 5px;
      background: #fff;
      padding: 15px;
      outline: none;
      width: 100%;
      margin-bottom: 20px;
      transition: 0.3s;
      -webkit-transition: 0.3s;
      -moz-transition: 0.3s;
    }

    .main-div input:focus {
      border: 1px solid #777;
    }

    .edit-button {
      margin-left: 5px;
      background: #5d8ffc;
      color: #fff;
      border: 1px solid #5d8ffc;
      border-radius: 1px;
      padding: 5px;
      transition: 0.1s;
      -webkit-transition: 0.3s;
      -moz-transition: 0.3s;
    }

    .square-button {
      height: 35px;
      width: 35px;
    }

    .remove-button {
      margin-left: 5px;
      background: #cc0000;
      color: #000000;
      border: 1px solid #000000;
      border-radius: 1px;
      padding: 5px;
      transition: 0.1s;
      -webkit-transition: 0.3s;
      -moz-transition: 0.3s;
    }

    .edit-button:hover:enabled {
      background: #fff;
      color: #5d8ffc;
      border: 1px solid #5d8ffc;
      cursor: pointer;
    }

    .main-div button,
    .loggedin-div button {
      background: #5d8ffc;
      color: #fff;
      border: 1px solid #5d8ffc;
      border-radius: 5px;
      padding: 15px;
      display: block;
      width: 100%;
      transition: 0.3s;
      -webkit-transition: 0.3s;
      -moz-transition: 0.3s;
    }

    .main-div button:hover,
    .loggedin-div button:hover {
      background: #fff;
      color: #5d8ffc;
      border: 1px solid #5d8ffc;
      cursor: pointer;
    }

    .competition-div {
      width: 50%;
      margin: 0px auto;
      margin-top: 150px;
      padding: 20px;
      display: none;
    }

    .competition-table {
      background: inherit;
      border-radius: 3px;
      border-collapse: collapse;
      height: 200px;
      margin: auto;
      max-width: 1080px;
      padding: 5px;
      width: 100%;
      animation: float 5s infinite;
    }

    .invisible-children {
      opacity: 0.1;
    }

    .invisible-children button {
      background-color: inherit;
      box-shadow: none;
      border-color: transparent;
    }

    .leaderboard-div {
      width: 30%;
      margin: 0px auto;
      margin-top: 150px;
      padding: 20px;
      display: none;
    }

    .leaderboard-table {
      background: inherit;
      border-radius: 3px;
      border-collapse: collapse;
      height: 200px;
      margin: auto;
      max-width: 1080px;
      padding: 5px;
      width: 100%;
      animation: float 5s infinite;
    }

    .multiplayer-table {
      display: none;
      background: inherit;
      border-radius: 3px;
      border: 1px transparent;
      border-collapse: collapse;
      height: 200px;
      margin: auto;
      max-width: 1080px;
      padding: 0px;
      width: 100%;
      animation: float 5s infinite;
    }

    .multiplayer-table tr td,
    .multiplayer-table tr th {
      min-width: 120px;
      max-width: 240px;
    }

    .multiplayer-table tr {
      border-top: none;
    }

    .multiplayer-table th {
      background-color: #d00000;
      font-weight: bold;
      font-size: larger;
    }

    .multiplayer-table td {
      color: white;
      background-color: inherit;
    }

    .print-enabled,
    .print-enabled-1,
    .print-enabled-2 {
      display: none;
    }


    .print-div {
      display: none;
    }

    .img-center {
      margin-top: -50px;
      margin-left: auto;
      margin-right: auto;
    }

    @media print {
      @page {
        size: landscape;
        margin-top: 0.5in;
        margin-bottom: 0.5in;
        margin-left: 0.5in;
        margin-right: 0.5in;
      }

      .print-div {
        display: block;
        padding: 20px;
      }

      .navbar {
        display: none;
      }

      .print-disabled {
        display: none;
      }

      .img-center {
        margin-top: -50px;
      }

      .print-enabled {
        display: block;
      }

      .print-enabled-1 {
        display: block;
        position: fixed;
        bottom: 0px;
        left: 0;
        font-size: 11px;
      }

      .print-enabled-2 {
        display: block;
        position: fixed;
        bottom: 0px;
        right: 0;
        font-size: 11px;
      }

      .right-border-disabled {
        border-right: none !important;
      }

      .left-border-disabled {
        border-left: none !important;
      }

      .invert-color {
        filter: invert(100%);
      }

      table {
        border: solid #000 !important;
        border-width: 1px 0 0 1px !important;
      }

      th,
      td {
        border: solid #000 !important;
        border-width: 0 1px 1px 0 !important;
      }

      html,
      body {
        height: 100%;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden;
      }

      .multiplayer-table-div {
        margin: 0px auto !important;
        margin-bottom: 20px !important;
        top: 0px !important;
        min-width: 80% !important;
        max-width: 80% !important;
        left: 50% !important;
        right: 50% !important;
      }

      .footer {
        display: none;
      }
    }

    .game-setup-div {
      width: 30%;
      min-width: 300px;
      margin: 0px auto;
      margin-top: 150px;
      padding: 20px;
      display: none;
    }

    .game-setup-table {
      background: inherit;
      border-radius: 3px;
      border-collapse: collapse;
      height: 200px;
      margin: auto;
      max-width: 1080px;
      padding: 5px;
      width: 100%;
      animation: float 5s infinite;
    }

    .player-input {
      display: block;
      width: 95%;
      margin-top: 2px;
      margin-bottom: 2px;
      padding-top: 20px;
      border: none;
      border-radius: 0;
      color: white;
      background: #333;
      font-size: 15px;
      transition: .3s ease;
    }

    .player-color-cell {
      border: none;
      background: inherit;
    }

    .player-cell {
      border: none;
      background: inherit;
    }

    .nohover {
      border: none;
      background: inherit;
    }

    .multiplayer-setup-div {
      width: 40%;
      min-width: 500px;
      margin: 0px auto;
      margin-top: 70px;
      padding: 20px;
      padding-bottom: 0;
      display: none;
    }

    .multiplayer-setup-table {
      background: inherit;
      border-radius: 3px;
      border-collapse: collapse;
      height: 200px;
      margin: auto;
      max-width: 1080px;
      padding: 5px;
      width: 100%;
      animation: float 5s infinite;
    }

    .multiplayer-table-div {
      width: 70%;
      max-width: 900px;
      margin: 0px auto;
      margin-top: 0;
      margin-bottom: 40px;
      padding: 20px;
      padding-bottom: 0px;
      display: none;
    }

    .footer {
      display: none;
      background-color: red;
      border-top: 2px solid #303030;
      position: fixed;
      bottom: 0;
      min-width: 100%;
      max-width: 100%;
    }

    .footer-link {
      text-decoration: underline;
      color: white;
    }

    tr:hover:not(.nohover) td {
      background: dimgray;
      color: #FFFFFF;
      border-top: 1px solid #22262e;
    }

    td {
      background: #FFFFFF;
      border-left: 1px solid #9ea7af;
      padding: 20px;
      text-align: center;
      vertical-align: middle;
      font-weight: 300;
      font-size: 18px;
      text-shadow: -1px -1px 1px rgba(0, 0, 0, 0.1);
      border-right: 1px solid #C1C3D1;
    }

    td:first-child {
      text-align: center;
    }

    .remove-cell {
      background: inherit;
      border-left: 1px solid #9ea7af;
      border-right: 1px solid #9ea7af;
      border-top: none;
      border-bottom: none;
      padding: 5px;
      text-align: center;
      vertical-align: middle;
      font-weight: 300;
      font-size: 18px;
      text-shadow: -1px -1px 1px rgba(0, 0, 0, 0.1);
    }

    th {
      color: #D5DDE5;
      ;
      background: #1b1e24;
      padding-left: 5px;
      border-bottom: 3px solid #9ea7af;
      border-right: 1px solid #343a45;
      font-size: 23px;
      font-weight: 100;
      padding: 12px;
      text-align: center;
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
      vertical-align: middle;
    }

    th:not(p) {
      text-align: center;
    }

    tr {
      border-top: 1px solid #C1C3D1;
      border-bottom: 1px solid #C1C3D1;
      color: #666B85;
      font-size: 16px;
      font-weight: normal;
      text-shadow: 0 1px 1px rgba(256, 256, 256, 0.1);
    }

    #registerPopup {
      display: none;
      /* Hidden by default */
      position: fixed;
      /* Stay in place */
      z-index: 1;
      /* Sit on top */
      padding-top: 100px;
      /* Location of the box */
      left: 0;
      top: 0;
      width: 100%;
      /* Full width */
      height: 100%;
      /* Full height */
      overflow: auto;
      /* Enable scroll if needed */
      background-color: rgb(0, 0, 0);
      /* Fallback color */
      background-color: rgba(0, 0, 0, 0.4);
      /* Black w/ opacity */
    }

    #loginPopup,
    #registerPopup {
      display: none;
      /* Hidden by default */
      position: fixed;
      /* Stay in place */
      z-index: 1;
      /* Sit on top */
      padding-top: 100px;
      /* Location of the box */
      left: 0;
      top: 0;
      width: 100%;
      /* Full width */
      height: 100%;
      /* Full height */
      overflow: auto;
      /* Enable scroll if needed */
      background-color: rgb(0, 0, 0);
      /* Fallback color */
      background-color: rgba(0, 0, 0, 0.4);
      /* Black w/ opacity */
    }

    .register-form-nick-div {
      display: none;
    }

    /* Fix the button on the left side of the page */
    .open-btn {
      display: flex;
      justify-content: left;
    }

    /* Style and fix the button on the page */
    .open-button {
      background-color: #1c87c9;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      opacity: 0.8;
      position: fixed;
    }

    /* Hide the Popup form */
    .form-popup {
      border: 2px solid #666;
      z-index: 9;
      max-width: 300px;
      margin: 0 auto;
    }

    /* Styles for the form container */
    .form-container {
      max-width: 300px;
      padding: 20px;
      background-color: #fff;
    }

    /* Full-width for input fields */
    .form-container input[type=text],
    .form-container input[type=password] {
      width: 100%;
      padding: 10px;
      margin: 5px 0 22px 0;
      border: none;
      background: #eee;
    }

    /* When the inputs get focus, do something */
    .form-container input[type=text]:focus,
    .form-container input[type=password]:focus {
      background-color: #ddd;
      outline: none;
    }

    /* Style submit/login button */
    .form-container .btn {
      background-color: #8ebf42;
      color: #fff;
      padding: 12px 20px;
      border: none;
      cursor: pointer;
      width: 100%;
      margin-bottom: 10px;
      opacity: 0.8;
    }

    /* Style cancel button */
    .form-container .cancel {
      background-color: #cc0000;
    }

    /* Hover effects for buttons */
    .form-container .btn:hover,
    .open-button:hover {
      opacity: 1;
    }

    #alert {
      position: fixed;
      display: none;
      text-align: center;
      padding: 30px;
      width: 20%;
      height: 10%;
      top: 5%;
      left: 40%;
      background-color: red;
      z-index: 3;
    }

    #alert_text {
      top: 50%;
      color: white;
      font-family: Helvetica;
      font-size: large;
    }

    #overlay {
      position: fixed;
      display: none;
      width: 100%;
      height: 100%;
      cursor: progress;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.3);
      z-index: 2;
    }
  </style>
  <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-messaging.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-functions.js"></script>
  <script lang="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.14.5/xlsx.full.min.js"></script>
  <script type="text/javascript" src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <!--<link rel="stylesheet" type="text/css" href="style.css" />-->
  <title>Trainshot</title>
  <link href="https://fonts.googleapis.com/css?family=Nunito:400,600,700" rel="stylesheet">
  <!-- <link href="style.css" /> -->
  <!-- <script src="../pages/login.js"></script> -->
</head>

<body>
  <div id="overlay"></div>
  <div id="navbar" class="navbar appear-on-hover">
    <button id="homeButton" class="edit-button print-disabled" onclick="homeButton()">Home</button>
    <button id="logoutButton" class="edit-button print-disabled" onclick="logout()">Logout</button>
  </div>

  <div id="alert">
    <p id="alert_text">Error</p>
  </div>

  <div id="login_div" class="main-div">
    <image src="https://www.trainshot.com/wp-content/uploads/2019/07/Trainshot-logo-inverted.png" width="300 height="
      112"></image>
    <input type="email" placeholder="Email..." id="email_field" />
    <input type="password" placeholder="Password..." id="password_field" />

    <button onclick="login()" id="login_button">Login to Account</button>
  </div>

  <div id="user_div" class="loggedin-div">
    <h3 style="text-align: center;">Trainshot Manager</h3>
    <p id="user_para">Currently logged in.</p>
    <hr>
    <button onclick="createNewCompetition()" style="margin-bottom: 5px;">New Competition</button>
    <button onclick="getCompetition()" style="margin-bottom: 5px;">Competitions</button>
    <hr>
    <button onclick="createNewMultiplayerGame()" style="margin-bottom: 5px;">New Mutliplayer Game</button>
    <button onclick="loadingCursorOn();StartMultiplayerRefresh()" style="margin-bottom: 5px;">Multiplayer
      Leaderboard</button>
    <hr>
  </div>


  <div id="loginPopup">
    <div class="form-popup" id="popupForm">
      <form class="form-container">
        <h2>User Data</h2>
        <input type="text" id="email" placeholder="Email" name="email" required>
        <input type="text" id="first_name" placeholder="First Name" name="first_name" required>
        <input type="text" id="last_name" placeholder="Last Name" name="last_name" required>
        <input type="text" id="phone_number" placeholder="Phone Number" name="phone_number" required>
        <button type="button" class="btn" onclick="writeUserData()">Add User</button>
        <button type="button" class="btn cancel" onclick="closeForm()">Close</button>
      </form>
    </div>
  </div>

  <div id="registerPopup">
    <div class="form-popup" id="popupForm">
      <form class="form-container">
        <h2>Login to game</h2>
        <input type="text" id="user_registration_email" placeholder="Email" required>
        <input type="password" id="user_registration_password" placeholder="Password" required>
        <div class="register-form-nick-div" id="register_form_nick_div">
          <input type="text" id="user_registration_first_name" placeholder="First Name" value="">
          <input type="text" id="user_registration_last_name" placeholder="Last Name" value="">
          <input type="text" id="user_registration_nick" placeholder="Nick" value="">
        </div>
        <button type="button" class="btn" onclick="loginPlayerForCompetition()">Add User</button>
        <button type="button" class="btn cancel" onclick="closeForm()">Close</button>
      </form>
    </div>
  </div>


  <div id="competition_div" class="competition-div">
    <button id="back_button" class="edit-button" style="display: none;" onclick="backButton()">Back</button>
    <table id="competition_table" class="competition-table">

    </table>
    <button class="edit-button" onclick="removeCompetitionData()">Remove Competition Data</button>
  </div>

  <div id="multiplayer_setup_div" class="multiplayer-setup-div">
    <table id="multiplayer_table" class="leaderboard-table">
      <tr class="nohover">
        <td class="player-cell">
          <input type="text" id="player_1_name" placeholder="Player 1" class="player-input">
        </td>
        <td class="player-cell">
          <input type="text" id="player_1_mail" placeholder="Email (optional)" class="player-input">
        </td>
        <td class="player-cell">
          <button class="edit-button square-button" id="verify_1" onclick="verifyEmail(1)">✓</button>
          <button class="edit-button square-button" onclick="removeMultiplayerEntry(1)">&#10005;</button>
        </td>
        <td class="player-color-cell"><img src="icon_dot_green.png" width="25" height="25" alt="Green"> </td>
      </tr>
      <tr class="nohover">
        <td class="player-cell">
          <input type="text" id="player_2_name" placeholder="Player 2" class="player-input">
        </td>
        <td class="player-cell">
          <input type="text" id="player_2_mail" placeholder="Email (optional)" class="player-input">
        </td>
        <td class="player-cell">
          <button class="edit-button square-button" id="verify_2" onclick="verifyEmail(2)">✓</button>
          <button class="edit-button square-button" onclick="removeMultiplayerEntry(2)">&#10005;</button>
        </td>
        <td class="player-color-cell"><img src="icon_dot_purple.png" width="25" height="25" alt="Purple"> </td>
      </tr>
      <tr class="nohover">
        <td class="player-cell">
          <input type="text" id="player_3_name" placeholder="Player 3" class="player-input">
        </td>
        <td class="player-cell">
          <input type="text" id="player_3_mail" placeholder="Email (optional)" class="player-input">
        </td>
        <td class="player-cell">
          <button class="edit-button square-button" id="verify_3" onclick="verifyEmail(3)">✓</button>
          <button class="edit-button square-button" onclick="removeMultiplayerEntry(3)">&#10005;</button>
        </td>
        <td class="player-color-cell"><img src="icon_dot_aqua.png" width="25" height="25" alt="Aqua"> </td>
      </tr>
      <tr class="nohover">
        <td class="player-cell">
          <input type="text" id="player_4_name" placeholder="Player 4" class="player-input">
        </td>
        <td class="player-cell">
          <input type="text" id="player_4_mail" placeholder="Email (optional)" class="player-input">
        </td>
        <td class="player-cell">
          <button class="edit-button square-button" id="verify_4" onclick="verifyEmail(4)">✓</button>
          <button class="edit-button square-button" onclick="removeMultiplayerEntry(4)">&#10005;</button>
        </td>
        <td class="player-color-cell"><img src="icon_dot_red.png" width="25" height="25" alt="Red"> </td>
      </tr>
      <tr class="nohover">
        <td class="player-cell">
          <input type="text" id="player_5_name" placeholder="Player 5" class="player-input">
        </td>
        <td class="player-cell">
          <input type="text" id="player_5_mail" placeholder="Email (optional)" class="player-input">
        </td>
        <td class="player-cell">
          <button class="edit-button square-button" id="verify_5" onclick="verifyEmail(5)">✓</button>
          <button class="edit-button square-button" onclick="removeMultiplayerEntry(5)">&#10005;</button>
        </td>
        <td class="player-color-cell"><img src="icon_dot_blue.png" width="25" height="25" alt="Blue"> </td>
      </tr>
      <tr class="nohover">
        <td class="player-cell">
          <input type="text" id="player_6_name" placeholder="Player 6" class="player-input">
        </td>
        <td class="player-cell">
          <input type="text" id="player_6_mail" placeholder="Email (optional)" class="player-input">
        </td>
        <td class="player-cell">
          <button class="edit-button square-button" id="verify_6" onclick="verifyEmail(6)">✓</button>
          <button class="edit-button square-button" onclick="removeMultiplayerEntry(6)">&#10005;</button>
        </td>
        <td class="player-color-cell"><img src="icon_dot_white.png" width="25" height="25" alt="White"> </td>
      </tr>
      <tr class="nohover">
        <td class="player-cell" colspan="3">
          <p style="color: white; font-weight: bold; padding-top: 10px;">Respawn Time</p>
          <button class="edit-button" style="min-width: 30px;" onclick="respawnPickerDec();">-</button>
          <input type="text" id="respawn_picker" size="2" value="6">
          <button class="edit-button" style="min-width: 30px;" onclick="respawnPickerInc();">+</button>
          <p>Sets the speed at which targets light up, on average, each player should see one target in this time period
          </p>
        </td>
      </tr>
      <tr class="nohover">
        <td class="player-cell" colspan="3">
          <p style="color: white; font-weight: bold; padding-top: 10px;">Targets per Player</p>
          <button class="edit-button" style="min-width: 30px;" onclick="bulletPickerDec();">-</button>
          <input type="text" id="bullet_picker" size="2" value="20">
          <button class="edit-button" style="min-width: 30px;" onclick="bulletPickerInc();">+</button>
          <p>Sets the number of targets each player has to shoot down</p>
        </td>
      </tr>
      <tr class="nohover">
        <td class="player-cell" style="padding-top: 15px;" colspan="3">
          <select id="choose_song">
            <option value="1">Matrix</option>
            <option value="2">Drums</option>
            <option value="3">Epic</option>
          </select>
        </td>
      </tr>
      <tr class="nohover" style="padding-top: 20px">

        <td class="player-cell" colspan="3">
          <hr>
          <button onclick="finishMultiplayerCreation();" class="edit-button">Create Game</button>
        </td>
      </tr>
    </table>
  </div>

  <div id="multiplayer_table_div" class="multiplayer-table-div">
    <img id="partner_icon_white" class="img-center" src="PartnerLogoWhite.png" style="display: block;" width="auto"
      height="100" alt="Trainshot Logo">
    <img class="print-disabled invert-color" src="TrainshotLogoWhite.png" width="150" height="auto"
      style="display: flex; float: right; padding-bottom: 10px; margin-top: 7px;">
    <img class="print-enabled invert-color" src="TrainshotLogoBlack.png" width="150" height="auto"
      style="display: none; float: right; padding-bottom: 10px; margin-top: -10px;">
    <div style="padding-bottom: 3%;"></div>
    <div id="game_started_div" style="display: block;">
      <p id="game_info_field" style="color: white; float: left;">GAME STARTED!</p>
      <p id="game_date_field" style="color: white; float: right;"></p>
    </div>
    <table id="multiplayer_average_table" class="multiplayer-table">
    </table>

    <div style="padding: 10px;"></div>

    <table id="multiplayer_session_table" class="multiplayer-table">
    </table>

    <table id="multiplayer_alltime_table" class="multiplayer-table">
    </table>
  </div>

  <a class="print-enabled-1">Trainshot.com/Airsoft</a>
  <a class="print-enabled-2">Lumberjacks.be</a>
  <footer id="footer" class="footer">
    <img style="float: left; padding: 3px;" class="print-disabled" src="facebook_logo.png" width="20px" height="auto">
    <img style="float: left; padding: 3px;" class="print-disabled" src="web_logo.png" width="20px" height="auto">
    <a style="padding-right: 5px;" class="print-disabled footer-link" target="_blank" and rel="noopener noreferrer"
      href="https://www.trainshot.com/airsoft/">Trainshot.com/Airsoft</a>
    <img id="partner_logo" style="float: right; padding: 3px;" class="print-disabled" src="partner_logo.png"
      width="20px" height="auto">
    <a id="partner_web" class="print-disabled footer-link" style="float: right;" target="_blank" and
      rel="noopener noreferrer" href="https://www.lumberjacks.be/">Lumberjacks.be</a>
    <a style="display: none; color: transparent;">动态网自由门 天安門 天安门 法輪功 李洪志 Free Tibet 六四天安門事件 The Tiananmen Square
      protests of 1989 天安門大屠殺 The Tiananmen Square Massacre 反右派鬥爭 The Anti-Rightist Struggle 大躍進政策 The Great Leap
      Forward 文化大革命 The Great Proletarian Cultural Revolution 人權 Human Rights 民運 Democratization 自由 Freedom 獨立
      Independence 多黨制 Multi-party system 台灣 臺灣 Taiwan Formosa 中華民國 Republic of China 西藏 土伯特 唐古特 Tibet 達賴喇嘛 Dalai Lama
      法輪功 Falun Dafa 新疆維吾爾自治區 The Xinjiang Uyghur Autonomous Region 諾貝爾和平獎 Nobel Peace Prize 劉暁波 Liu Xiaobo 民主 言論 思想 反共
      反革命 抗議 運動 騷亂 暴亂 騷擾 擾亂 抗暴 平反 維權 示威游行 李洪志 法輪大法 大法弟子 強制斷種 強制堕胎 民族淨化 人體實驗 肅清 胡耀邦 趙紫陽 魏京生 王丹 還政於民 和平演變 激流中國 北京之春 大紀元時報
      九評論共産黨 獨裁 專制 壓制 統一 監視 鎮壓 迫害 侵略 掠奪 破壞 拷問 屠殺 活摘器官 誘拐 買賣人口 遊進 走私 毒品 賣淫 春畫 賭博 六合彩 天安門 天安门 法輪功 李洪志 Winnie the Pooh
      劉曉波动态网自由门</a>
  </footer>

  <div id="game_setup_div" class="game-setup-div">
    <select id="choose_competition">
      <option value="0">Single Target Medium</option>
      <option value="1">4 Targets Medium</option>
      <option value="2">4 Targets Hard</option>
    </select>
    <table id="player_table" class="game-setup-table">

    </table>
    <div id="create_game">
      <button onclick="finishCompetitionCreation();">Create Game</button>
    </div>
  </div>

  <div id="leaderboard_div" class="leaderboard-div">
    <table id="leaderboard_table" class="leaderboard-table">

    </table>
  </div>

  <script>
    window.onbeforeunload = function (e) {
      return "Don't leave";
    };
    // Your web app's Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyCifAhP0t57mMVQ7MGoFkUYuafGKFV9OSo",
      authDomain: "trainshot-213ba.firebaseapp.com",
      databaseURL: "https://trainshot-213ba.firebaseio.com",
      projectId: "trainshot-213ba",
      storageBucket: "trainshot-213ba.appspot.com",
      messagingSenderId: "903882124417",
      appId: "1:903882124417:web:50ed3363b913ed1f"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
  </script>

  <script>
    var signedUsers = [];
    var competition = [{
      "Date": "01/01/2000 00:00:00",
      "ID": "1",
      "Name": "Single Target",
      "Trashed": "False",
      "stage": [null, {
        "Drill": "ABCDEDrill",
        "ID": "1",
        "IsDrill": "False",
        "Name": "Single Target",
        "modeInfo": {
          "Bullets": "10",
          "DoubleTap": "False",
          "ModeName": "Reflex",
          "Multizone": "False",
          "RandomMaxInterval": "2000",
          "RandomMinInterval": "350",
          "ReflexMode": "True",
          "StealthMode": "False",
          "Success": "False",
          "TargetsAtOnce": "1",
          "targets": [null, "Airsoft"]
        }
      }]
    },
    {
      "Date": "01/01/2000 00:00:00",
      "ID": "1",
      "Name": "4 Targets Medium",
      "Trashed": "False",
      "stage": [null, {
        "Drill": "ABCDEDrill",
        "ID": "1",
        "IsDrill": "False",
        "Name": "4 Targets Medium",
        "modeInfo": {
          "Bullets": "20",
          "DoubleTap": "False",
          "ModeName": "MultiReflex",
          "Multizone": "False",
          "RandomMaxInterval": "2000",
          "RandomMinInterval": "350",
          "ReflexMode": "True",
          "StealthMode": "False",
          "Success": "False",
          "TargetsAtOnce": "1",
          "targets": [null, "Airsoft", "Airsoft", "Airsoft", "Airsoft"]
        }
      }]
    },
    {
      "Date": "01/01/2000 00:00:00",
      "ID": "1",
      "Name": "4 Targets Hard",
      "Trashed": "False",
      "stage": [null, {
        "Drill": "ABCDEDrill",
        "ID": "1",
        "IsDrill": "False",
        "Name": "4 Targets Hard",
        "modeInfo": {
          "Bullets": "20",
          "DoubleTap": "False",
          "ModeName": "MultiReflex",
          "Multizone": "False",
          "RandomMaxInterval": "1500",
          "RandomMinInterval": "100",
          "ReflexMode": "True",
          "StealthMode": "False",
          "Success": "False",
          "TargetsAtOnce": "1",
          "targets": [null, "Airsoft", "Airsoft", "Airsoft", "Airsoft"]
        }
      }]
    }
    ];

    function loadingCursorOn() {
      document.getElementById("overlay").style.display = "block";
    }

    function loadingCursorOff() {
      document.getElementById("overlay").style.display = "none";
    }

    document.getElementById("password_field").addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("login_button").click();
      }
    });
    document.getElementById("player_1_mail").addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("verify_1").click();
      }
    });
    document.getElementById("player_1_name").addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("verify_1").click();
      }
    });
    document.getElementById("player_2_mail").addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("verify_2").click();
      }
    });
    document.getElementById("player_2_name").addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("verify_2").click();
      }
    });
    document.getElementById("player_3_mail").addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("verify_3").click();
      }
    });
    document.getElementById("player_3_name").addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("verify_3").click();
      }
    });
    document.getElementById("player_4_mail").addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("verify_4").click();
      }
    });
    document.getElementById("player_4_name").addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("verify_4").click();
      }
    });
    document.getElementById("player_5_mail").addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("verify_5").click();
      }
    });
    document.getElementById("player_5_name").addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("verify_5").click();
      }
    });
    document.getElementById("player_6_mail").addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("verify_6").click();
      }
    });
    document.getElementById("player_6_name").addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("verify_6").click();
      }
    });
    let rowEnd = "</tr>";
    let rowStart = "<tr>";
    let columnStart = "<td>";
    let columnEnd = "</td>";
    let editStagesButton = "";
    let editShootersButton = "";
    var database = firebase.database();
    var userId;
    var isManager = true;
    var currentGameID = 0;

    firebase.auth().onAuthStateChanged(function (user) {
      console.log(user);
      if (user && isManager == true) {
        // User is signed in.
        // var user = firebase.auth().currentUser;
        // console.log("USER:" + user + "\n");
        if (user != null) {

          var email_id = user.email;
          // console.log(user);
          // console.log(user.uid);
          document.getElementById("user_para").innerHTML = "User : " + email_id;

          var ref = database.ref('/users/' + user.uid).once('value').then(function (snapshot) {
            let userData = snapshot.val();
            // console.log(userData);
            if (userData.canManageCompetition == "TRUE") {
              document.getElementById("user_div").style.display = "block";
              document.getElementById("login_div").style.display = "none";
              document.getElementById("navbar").style.display = "block";
              document.getElementById("password_field").innerHTML = "";
              console.log("login successful");
              loadingCursorOff();
            }
            else {
              loadingCursorOff();
              userData = null;
              firebase.auth().signOut();
            }
          });

          // var ref = database.ref('/competition/' + "1").once('value').then(function (snapshot) {
          //   let competitionData = snapshot.val();
          //   // console.log(competitionData);
          // });
        }

      } else {
        // No user is signed in.

        document.getElementById("user_div").style.display = "none";
        document.getElementById("login_div").style.display = "block";

      }
    });

    function getPlayerData(player) {
      var ref = database.ref('/users/' + player + '/user').once('value').then(function (snapshot) {
        let playerData = snapshot.val();
        console.log(playerData);
        return playerData;
      }).catch(function (error) {
        console.log(error);
      });
    }

    async function login() {

      loadingCursorOn();
      var userEmail = document.getElementById("email_field").value;
      var userPass = document.getElementById("password_field").value;
      competitionManagerEmail = userEmail;
      competitionManagerPassword = userPass;
      // console.log(userPass);
      // console.log(userEmail);
      isManager = true;
      await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION).then(function () {
        firebase.auth().signInWithEmailAndPassword(userEmail, userPass).catch(function (error) {
          // Handle Errors here.
          var errorCode = error.code;
          var errorMessage = error.message;
          loadingCursorOff();

          customAlert("Error : " + errorMessage, "red");
          // ...
        });
      }).catch(function (error) {
        // Handle Errors here.
        loadingCursorOff();
        var errorCode = error.code;
        var errorMessage = error.message;
      });
    }

    // async function fakeVotes(){
    //   var name = Math.random().toString(36).substr(2, 5) + " " + Math.random().toString(36).substr(2, 5);
    //   var email = Math.random().toString(36).substr(2, 5) + "@" + Math.random().toString(36).substr(2, 5) + "." + "com";
    //   //document.getElementsByName("name")[0].innerHTML = name;
    //   document.getElementsByName("name")[0].value = name;
    //   console.log(document.getElementsByName("email")[0]);
    //   document.getElementsByName("email")[0].value = name;
    //   //document.getElementsByName("email")[0].innerHTML = email;
    //   for(const x of document.querySelectorAll("input")){if (x.name == "checkbox" && x.checked == false) x.click();}
    //   for(const x of document.querySelectorAll("button")){if (x.innerHTML == "Submit") x.click();}
    // }
    // fakeVotes();

    // Data pull
    var userData;
    async function getCompetition() {
      var user = firebase.auth().currentUser;
      userId = user.uid;
      loadingCursorOn();
      await firebase.database().ref('/users/' + userId).once('value').then(function (snapshot) {
        userData = snapshot.val()
        console.log(userData);
        parseCompetitionData(userData);
        document.getElementById("back_button").style.display = "none";
        document.getElementById("user_div").style.display = "none";
        document.getElementById("login_div").style.display = "none";
        document.getElementById("competition_div").style.display = "block";
      }).catch(function (error) {

        customAlert("No competition data available.", "red");
      });
      loadingCursorOff();
    }

    function createNewMultiplayerGame() {

      document.getElementById("multiplayer_setup_div").style.display = "block";
      document.getElementById("user_div").style.display = "none";
    }

    var multiplayerAddedListener;
    var gameIDListener;

    async function StartMultiplayerRefresh() {
      var newGameID = currentGameID;
      document.getElementsByTagName("body")[0].style.overflow = "hidden";
      userId = user = firebase.auth().currentUser.uid;
      await firebase.database().ref('/users/' + userId + '/multiplayer/GameID').once('value').then(function (snapshot) {
        newGameID = snapshot.val();
        if (currentGameID < newGameID) currentGameID = newGameID;
      }, function (error) {
        customAlert("No games found", "red");
      });



      await firebase.database().ref('/users/' + userId + '/multiplayer/results').once('value').then(function (snapshot) {
        var multiplayerResults = snapshot.val();


        gameIDListener = firebase.database().ref('/users/' + userId + '/multiplayer/GameID').on('value', function (snapshotGameID) {
          newGameID = snapshotGameID.val();
          currentGameID = newGameID;
          firebase.database().ref('/users/' + userId + '/multiplayer/results/' + currentGameID).once('value').then(function (snapshot) {
            multiplayerChangeListener = firebase.database().ref('/users/' + userId + '/multiplayer/results/' + currentGameID).on('value', function (snapshot) {
              showMultiplayerResults(snapshot);
            });
            if (snapshot.val() === null) {
              document.getElementById("multiplayer_average_table").innerHTML = "";
              document.getElementById("multiplayer_session_table").innerHTML = "";
              document.getElementById("game_info_field").innerHTML = "GAME STARTED!";
              document.getElementById("game_date_field").innerHTML = "";
            }
          });
        }, function (error) {
          customAlert("No games found", "red");
        });
        loadingCursorOff();
        document.getElementById("navbar").classList.add("invisible-children");
      });
    }

    function getDateFromResult(date) {
      return parseInt(date.substring(6, 8)).toString() + "."
        + parseInt(date.substring(4, 6)).toString() + ". "
        + parseInt(date.substring(0, 4)).toString() + " - "
        + parseInt(date.substring(8, 10)).toString() + ":"
        + ("00" + parseInt(date.substring(10, 12)).toString()).substr(-2, 2);
    }

    async function showMultiplayerResults(snapshot) {
      var multiplayerResults = snapshot.val();
      var formattedResults = [];
      var totalScores = {};
      var gameCount = 0;
      document.getElementById("leaderboard_table").innerHTML = "";
      document.getElementById("user_div").style.display = "none";
      document.getElementById("login_div").style.display = "none";
      document.getElementById("competition_div").style.display = "none";
      document.getElementById("game_setup_div").style.display = "none";
      document.getElementById("multiplayer_setup_div").style.display = "none";
      document.getElementById("multiplayer_table_div").style.display = "block";
      document.getElementById("multiplayer_average_table").style.display = "table";
      document.getElementById("multiplayer_session_table").style.display = "table";
      document.getElementById("footer").style.display = "block";
      for (var game in multiplayerResults) {
        gameCount++;
        var i = 0;
        for (var playerResult in multiplayerResults[game]) {
          if (gameCount == 1 || !Object.keys(totalScores).includes(multiplayerResults[game][playerResult].Name)) {
            formattedResults.push({
              "Name": "",
              "totalTime": "0",
              "averageTime": "0",
            });
            totalScores[multiplayerResults[game][playerResult].Name] = parseFloat(multiplayerResults[game][playerResult].totalTime);
          }
          else {
            totalScores[multiplayerResults[game][playerResult].Name] += parseFloat(multiplayerResults[game][playerResult].totalTime);
          }
          formattedResults[i] = {
            "Name": multiplayerResults[game][playerResult].Name,
            "totalTime": parseFloat(formattedResults[i].totalTime) + parseFloat(multiplayerResults[game][playerResult].totalTime),
            "averageTime": parseFloat(formattedResults[i].averageTime) + parseFloat(multiplayerResults[game][playerResult].averageTime)
          };
          i++;
        }
      }
      var totalScores = Object.entries(totalScores).sort((a, b) => a[1] - b[1]);
      var tableString = rowStart + "<th colspan=\"2\">" + "Name" + "</th>" + "<th>" + "Color" + "</th>" + "<th colspan=\"2\" style=\"width: 40%;\">" + "Total time after " + gameCount + " round" + (gameCount > 1 ? "s" : "") + "</th>" + rowEnd;
      for (var i = 0; i < formattedResults.length; i++) {
        var color = totalScores[i][0].split(' ').pop();
        var imgalt = "<img class=\"print-disabled\" src=\"icon_dot_" + color.toLowerCase() + ".png\" width=\"35\" height=\"35\">" + "<p class=\"print-enabled\">" + color + "</p>"
        tableString += rowStart + "<td width=\"30\" class=\"right-border-disabled\" style=\"border-right: none\">" + (i < 3 ? "<img class=\"print-disabled\" src=\"medal_" + (i + 1) + ".png\" width=\"30\" height=\"35\">" + "<img class=\"print-enabled\" style=\"margin-left: 50px;\" src=\"medal_" + (i + 1) + "_inv.png\" width=\"30\" height=\"35\">" : ((i + 1) + ".")) + columnEnd
          + "<td class=\"left-border-disabled\" style=\"text-align: left; border-left: none;" + (i < 3 ? "font-weight: bold;" : "") + "\">" + totalScores[i][0].replace(/[\W]*\S+[\W]*$/, '') + columnEnd
          + "<td width=\"30\" style=\"\">" + imgalt + columnEnd
          + "<td style=\"width: 40%; text-align: center;\">" + totalScores[i][1].toFixed(2) + 's' + columnEnd + rowEnd;
      }
      if (gameCount > 0) document.getElementById("multiplayer_average_table").innerHTML = tableString;


      var players = new Array;
      gameCount = 0;
      for (var game in multiplayerResults) {
        for (var playerResult in multiplayerResults[game]) {
          if (players.indexOf(multiplayerResults[game][playerResult].Name) == -1 && multiplayerResults[game][playerResult].Name != 0) {
            players.push(multiplayerResults[game][playerResult].Name);
          }
        }
      }
      tableString = rowStart + "<thead> <th>" + "Round" + "</th>";
      for (var i = 0; i < players.length; i++) {
        tableString += "<th>" + players[i].replace(/[\W]*\S+[\W]*$/, '') + "</th>"
      }
      tableString += "</thead>";

      for (var game in multiplayerResults) {
        gameCount++;
        tableString += rowStart + "<td style=\"font-weight: bold;\">" + gameCount + columnEnd;
        players.forEach((item, index) => {
          var tempTime;
          try { tempTime = parseFloat(Object.values(multiplayerResults[game]).find(x => x.Name == item).totalTime).toFixed(2) + "s"; }
          catch {
            tempTime = "-";
          }
          tableString += columnStart + tempTime + columnEnd;
        });
        tableString += rowEnd;
      }
      document.getElementById("multiplayer_session_table").style.maxWidth = (players.length + 1) * 150 + "px";
      document.getElementById("multiplayer_average_table").style.maxWidth = (players.length + 1) * 150 + "px";
      if (gameCount > 0) {
        document.getElementById("game_info_field").innerHTML = "Multiplayer Game No. " + currentGameID;
        document.getElementById("game_info_field").style = "font-weight: bold; font-size: larger; color: white; text-align: left; float: left;";

        document.getElementById("game_date_field").innerHTML = "" + getDateFromResult(Object.keys(multiplayerResults)[0]);
        document.getElementById("game_date_field").style = "font-weight: bold; font-size: larger; color: white; text-align: center;";
        document.getElementById("multiplayer_session_table").innerHTML = tableString;
        if (gameCount > 6) {
          document.getElementsByTagName("body")[0].style.overflow = "initial";
        }
      }
    }


    var PlayerList;
    function finishMultiplayerCreation() {

      PlayerList = ["", "", "", "", "", "", ""];
      PlayerList[1] = document.getElementById("player_1_name").value;
      PlayerList[2] = document.getElementById("player_2_name").value;
      PlayerList[3] = document.getElementById("player_3_name").value;
      PlayerList[4] = document.getElementById("player_4_name").value;
      PlayerList[5] = document.getElementById("player_5_name").value;
      PlayerList[6] = document.getElementById("player_6_name").value;
      var canFinishCreation = true;

      //Check if all players are locked
      for (var i = 1; i < 7; i++) {
        if (document.getElementById("player_" + i + "_name").disabled == false && document.getElementById("player_" + i + "_name").value != "") {
          canFinishCreation = false;
          customAlert("Lock in all players first!", "red");
          break;
        }
      }

      //Check if all players are null or equal
      if (PlayerList[1] == "" && PlayerList[2] == "" && PlayerList[3] == "" && PlayerList[4] == "" && PlayerList[5] == "" && PlayerList[6] == "") {
        canFinishCreation = false;
        customAlert("Cannot start a game with no players", "red");
      }

      if (canFinishCreation == true) {
        document.getElementById("multiplayer_average_table").innerHTML = "";
        document.getElementById("multiplayer_session_table").innerHTML = "";
        document.getElementById("game_info_field").innerHTML = "GAME STARTED!";
        document.getElementById("game_date_field").innerHTML = "";
        var RespawnSpeed = 0.0;
        var TargetsPerPlayer = 0;
        var SongID = 0;
        var userId = firebase.auth().currentUser.uid;
        SongID = document.getElementById("choose_song").value;
        TargetsPerPlayer = document.getElementById("bullet_picker").value;
        RespawnSpeed = document.getElementById("respawn_picker").value;

        firebase.database().ref('/users/' + userId + '/multiplayer/results').once('value').then(function (snapshot) {
          var multiplayerResults = snapshot.val();
          if (multiplayerResults == null) {
            currentGameID = 0;
          }
          else {
            currentGameID = parseInt(Object.keys(multiplayerResults)[Object.keys(multiplayerResults).length - 1]) + 1;
          }
          PlayerList[0] = currentGameID;
          firebase.database().ref('/users/' + userId + '/multiplayer/users').once('value').then(function (snapshot) {
            var userList = snapshot.val();
            for (var i = 0; i < PlayerList.length; i++) {
              if (PlayerList[i] != null && PlayerList[i] != "") {
                var playerIndex = userList.indexOf(userList.find(x => x.Nick == PlayerList[i]));
                if (playerIndex != -1) {
                  userList[playerIndex].Games.push(currentGameID);
                  firebase.database().ref('users/' + userId + '/multiplayer/users/' + playerIndex).update(userList[playerIndex]);
                }
              }
            }
          });

          if (TargetsPerPlayer <= 50 && TargetsPerPlayer >= 1 && RespawnSpeed >= 1 && RespawnSpeed <= 20) {
            var FirebaseMultiplayerReference = firebase.database().ref('users/' + userId + '/multiplayer');
            FirebaseMultiplayerReference.update({
              "Bullets": TargetsPerPlayer,
              "PlayerList": PlayerList,
              "Timeout": RespawnSpeed,
              "SongID": SongID,
              "GameID": currentGameID,
            }, function (error) {
              if (error) {
                console.log(error);
              } else {
                StartMultiplayerRefresh();
                console.log("Multiplayer setup successful");
              }
            });
          }

        });
      }
    }


    function validateEmail(email) {
      var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      return re.test(String(email).toLowerCase());
    }

    function removeMultiplayerEntry(playerID) {
      document.getElementById("player_" + playerID + "_name").disabled = false;
      document.getElementById("player_" + playerID + "_name").style.color = "white";
      document.getElementById("verify_" + playerID).style.backgroundColor = "#5d8ffc";
      document.getElementById("verify_" + playerID).style.border = "initial";
      document.getElementById("verify_" + playerID).disabled = false;
      document.getElementById("player_" + playerID + "_name").value = ""
      document.getElementById("player_" + playerID + "_mail").disabled = false;
      document.getElementById("player_" + playerID + "_mail").style.color = "white";
      document.getElementById("player_" + playerID + "_mail").value = "";
    }

    async function verifyEmail(playerID) {
      var userId = firebase.auth().currentUser.uid;
      var playerNick = document.getElementById("player_" + playerID + "_name").value;
      var playerMail = document.getElementById("player_" + playerID + "_mail").value.toLowerCase();
      var playersDatabase = [""];
      if (playerNick == "" && playerMail == "") {
        customAlert("Cannot validate empty data", "red");
      }
      else {
        firebase.database().ref('/users/' + userId + '/multiplayer/users').once('value').then(function (snapshot) {
          playersDatabase = snapshot.val();
          if (playersDatabase == null && playerMail != "" && playerNick != "") {
            console.log("null players database");
            firebase.database().ref('users/' + userId + '/multiplayer/users/' + 0).set({
              "Email": playerMail.toLowerCase(),
              "Nick": playerNick,
              "Games": [0]
            }, function (error) {
              customAlert("User added", "green");
              lockUser(playerID);
            });
          }
          else {
            var verifiedUser = playersDatabase.find(x => x.Email == playerMail)
            if ((playerMail == null || playerMail == "") && playerNick != null && playerNick != "") {
              lockUser(playerID);
            }
            else if (verifiedUser != null) {
              document.getElementById("player_" + playerID + "_name").value = verifiedUser.Nick;
              lockUser(playerID);
            } else {
              if (playerNick.length > 0 && validateEmail(playerMail)) {
                firebase.database().ref('users/' + userId + '/multiplayer/users/' + (playersDatabase.length)).set({
                  "Email": playerMail.toLowerCase(),
                  "Nick": playerNick,
                  "Games": [0]
                }, function (error) {
                  customAlert("User added", "green");
                  lockUser(playerID);
                });
              } else {
                if (playerMail != null && playerMail != "") {
                  if (playerNick == null || playerNick == "") {
                    customAlert("Missing Nick!", "red");
                  }
                  else {
                    customAlert("Invalid Email Format!", "red");
                  }
                }
              }
            }
          }
        });
      }
    }

    function lockUser(playerID) {
      document.getElementById("player_" + playerID + "_name").disabled = true;
      document.getElementById("player_" + playerID + "_name").style.color = "#b8b8b8";
      document.getElementById("player_" + playerID + "_mail").disabled = true;
      document.getElementById("player_" + playerID + "_mail").style.color = "#b8b8b8";
      document.getElementById("verify_" + playerID).style.backgroundColor = "green";
      document.getElementById("verify_" + playerID).style.border = "none";
      document.getElementById("verify_" + playerID).disabled = true;
      if (playerID < 6) {
        document.getElementById("player_" + (playerID + 1) + "_name").focus();
        document.getElementById("player_" + (playerID + 1) + "_name").select();
      }
    }

    function respawnPickerInc() {
      document.getElementById("respawn_picker").value < 20 ? document.getElementById("respawn_picker").value++ : null;
    }
    function respawnPickerDec() {
      document.getElementById("respawn_picker").value > 1 ? document.getElementById("respawn_picker").value-- : null;
    }
    function bulletPickerInc() {
      document.getElementById("bullet_picker").value < 50 ? document.getElementById("bullet_picker").value++ : null;
    }
    function bulletPickerDec() {
      document.getElementById("bullet_picker").value > 1 ? document.getElementById("bullet_picker").value-- : null;
    }


    function createNewCompetition() {
      var user = firebase.auth().currentUser;
      userId = user.uid;
      var newGameRef = firebase.database().ref('/users/' + userId + '/competition');
      newGameRef.once('value').then(function (snapshot) {
        var nextIndex = Object.keys(snapshot).length - 1 || 1;
      });
      var tableString = rowStart + "<th>" + "Name" + "</th>" + "<th>" + "Nick" + "</th>" + rowEnd;
      for (key in signedUsers) {
        tableString += rowStart + columnStart + signedUsers[key].firstName + " " + signedUsers[key].lastName + columnEnd + columnStart + signedUsers[key].nick + columnEnd + rowEnd;
      }
      tableString += "<button class=\"edit-button\" onclick=\"openRegisterForm()\">Add Shooter</button>";
      // for (key in signedUsers) {
      //   tableString += rowStart + columnStart + signedUsers[key].ID + columnEnd +
      //     columnStart + compData[key].Name + columnEnd +
      //     columnStart + compData[key].Date + editStagesButton + editShootersButton + columnEnd + rowEnd;
      // }

      document.getElementById("choose_competition").style.display = "block";
      document.getElementById("user_div").style.display = "none";
      document.getElementById("game_setup_div").style.display = "block";
      document.getElementById("player_table").innerHTML = tableString;
    }

    async function loginPlayerForCompetition() {
      isManager = false;
      var userEmail = document.getElementById("user_registration_email").value;
      var userPass = document.getElementById("user_registration_password").value;
      var failedLogin = false;
      var noCredentials = false;
      loadingCursorOn();
      await firebase.auth().signOut();
      await firebase.auth().signInWithEmailAndPassword(userEmail, userPass).catch(function (error) {
        var errorMessage = error.message;
        customAlert("Error : " + errorMessage, "red");
        failedLogin = true;
      });
      loadingCursorOff();
      if (failedLogin) {
        console.log("failed login !");
        await firebase.auth().signInWithEmailAndPassword(competitionManagerEmail, competitionManagerPassword);
        await homeButton();
        await createNewCompetition();
      }
      else {
        console.log("successful login !");
        var registerUserId = firebase.auth().currentUser.uid;
        loadingCursorOn();
        await firebase.database().ref('/users/' + registerUserId).once('value').then(function (snapshot) {
          var tempUserData = snapshot.val();
          if (tempUserData.user == null) {
            document.getElementById("register_form_nick_div").style.display = "block";
            noCredentials = true;
            var firstName = document.getElementById("user_registration_first_name").value;
            var lastName = document.getElementById("user_registration_last_name").value;
            var nick = document.getElementById("user_registration_nick").value;
            if (firstName != "" && lastName != "" && nick != "") {
              document.getElementById("register_form_nick_div").style.display = "none";
              noCredentials = false;
              firebase.database().ref('/users/' + registerUserId + '/user').set({
                "email": firebase.auth().currentUser.email,
                "firstName": firstName,
                "id": "1",
                "lastName": lastName,
                "nick": nick,
                "singleCompetition": [null, "Jebaltopes"]
              }, function (error) {
                if (error) {
                  console.log(error);
                } else {
                  signedUsers.push({
                    "email": firebase.auth().currentUser.email,
                    "firstName": firstName,
                    "id": "1",
                    "lastName": lastName,
                    "nick": nick,
                    "singleCompetition": [null, "Jebaltopes"]
                  });
                  console.log("Successfully added credentials");
                }
              });
            }
          }
          else {
            tempUserData.uid = registerUserId;
            signedUsers.push(tempUserData.user);
          }
        });
        loadingCursorOff();
        if (noCredentials == false) {
          await firebase.auth().signOut();
          document.getElementById("login_div").style.display = "none";
          await firebase.auth().signInWithEmailAndPassword(competitionManagerEmail, competitionManagerPassword);
          await homeButton();
          await createNewCompetition();
          await closeForm();
        }
        else {
          document.getElementById("login_div").style.display = "none";
        }
      }

    }

    async function finishCompetitionCreation() {
      var registerUserId = firebase.auth().currentUser.uid;
      var gameType = competition[document.getElementById("choose_competition").value];
      var competitionData = null;
      var nextPlayersIndex = 1;
      loadingCursorOn();
      await firebase.database().ref('/users/' + registerUserId).once('value').then(function (snapshot) {
        competitionData = snapshot.val().competition;
        if (competitionData == null) gameType.ID = "1";
        else {
          nextPlayersIndex = Math.max.apply(null, Object.keys(competitionData.shooters)) || 1;
          gameType.ID = Math.max.apply(null, Object.keys(competitionData.competitions)) + 1 || 1;
          for (x of signedUsers) {
            x.singleCompetition[gameType.ID] = {
              [gameType.ID]: {
                ID: gameType.ID
              }
            }
          }
        }
      });
      loadingCursorOff();
      //console.log("Competition next index = " + (Math.max.apply(null,Object.keys(competitionData.competition)) + 1) || 1);

      await firebase.database().ref('/users/' + registerUserId + '/competition/competitions/' + gameType.ID).set(gameType);
      for (x of signedUsers) {
        await firebase.database().ref('/users/' + registerUserId + '/competition/shooters/' + nextPlayersIndex++).set(x);
      }
    }

    function parseCompetitionData(userData) {
      var compData = userData.competition.competitions;
      var tableString = rowStart + "<th>" + "ID" + "</th>" + "<th>" + "Name" + "</th> <th>" + "Date" + "</th>" + rowEnd;
      //console.log(compData);
      for (key in compData) {
        // console.log(key);
        editStagesButton = "<button class=\"edit-button\" id=\"editStagesId" + compData[key].ID + "\"  onclick=\"editStages(this.id)\">Stages</button>";
        editShootersButton = "<button class=\"edit-button\" id=\"editUsersId" + compData[key].ID + "\"  onclick=\"editUsers()\">Users</button>";
        // console.log(compData[key].Date + " : " + compData[key].Name + "\n");
        tableString += rowStart + columnStart + compData[key].ID + columnEnd +
          columnStart + compData[key].Name + columnEnd +
          columnStart + compData[key].Date + editStagesButton + editShootersButton + "<button id=\"resultButton\" class=\"edit-button\" onclick=\"getResults()\">Results</button>" + columnEnd + rowEnd;
      }
      document.getElementById("competition_table").innerHTML = tableString;
    }

    function editStages(editId) {
      document.getElementById("back_button").style.display = "block";
      var tableString = rowStart + "<th>" + "ID" + "</th>" + "<th>" + "Name" + "</th>" + "<th>" + "Targets" + "</th>" + "<th>" + "Bullets" + "</th>" + "<th>" + "Intervals" + "</th>" + rowEnd;
      var id = editId.replace(/^\D+/g, '');
      // console.log(id);
      var compData = userData.competition.competitions[id].stage;
      // console.log(compData);
      for (key in compData) {
        var targetString = "";
        for (var i = 1; i < compData[key].modeInfo.targets.length; i++) {
          targetString += compData[key].modeInfo.targets[i] + (i < compData[key].modeInfo.targets.length - 1 ? ", " : "");
        }
        tableString += rowStart + columnStart + compData[key].ID + columnEnd +
          columnStart + compData[key].Name + columnEnd +
          columnStart + targetString + columnEnd +
          columnStart + compData[key].modeInfo.Bullets + columnEnd +
          columnStart + compData[key].modeInfo.RandomMinInterval + "-" + compData[key].modeInfo.RandomMaxInterval + columnEnd + rowEnd;
        // console.log(compData[key].Drill + compData[key].ID + compData[key].IsDrill + compData[key].Name);
      }

      document.getElementById("competition_table").innerHTML = tableString;
    }

    async function editUsers() {
      document.getElementById("back_button").style.display = "block";
      loadingCursorOn();
      await firebase.database().ref('/users/' + userId).once('value').then(function (snapshot) {
        userData = snapshot.val();
      });
      loadingCursorOff();
      var tableString = rowStart + "<th>" + "ID" + "</th>" + "<th>" + "Email" + "</th> <th>" + "First Name" + "</th> <th>" + "Last Name" + "</th><th>" + "Phone" + "</th>" + rowEnd;
      var compData = userData.competition.shooters;
      // console.log(compData);
      for (key in compData) {
        tableString += rowStart + columnStart + compData[key].ID + columnEnd +
          columnStart + compData[key].Email + columnEnd +
          columnStart + compData[key].FirstName + columnEnd +
          columnStart + compData[key].LastName + columnEnd +
          columnStart + compData[key].PhoneNumber + columnEnd +
          "<td class=\"remove-cell\">" + "<button class=\"remove-button\" onclick=\"removeUser(" + compData[key].ID + ")\" >X</button>" + columnEnd + rowEnd;
        // console.log(compData[key].Drill + compData[key].ID + compData[key].IsDrill + compData[key].Name);
      }
      tableString += rowStart + columnStart + "<button class=\"edit-button\" onclick=\"openForm()\">Add Shooter</button>" + columnEnd +
        columnStart + "<input type=\"file\" id=\"file_upload\">" + columnEnd + rowEnd;
      document.getElementById("competition_table").innerHTML = tableString;
      document.getElementById("file_upload").addEventListener('change', handleFile, false);
    }

    async function getResults() {
      if (document.getElementById("leaderboard_div").style.display == "block") {
        document.getElementById("leaderboard_div").style.display = "none";
      }
      else {
        loadingCursorOn();
        await firebase.database().ref('/users/' + userId).once('value').then(function (snapshot) {
          userData = snapshot.val();
        }).catch(function (error) {
          console.log("No competition data, error:" + error.message);
          customAler("No result data available", "red");
        });
        loadingCursorOff();
        var shooterData = userData.competition.shooters;
        var resultList = new Array();
        // console.log(shooterData);
        for (ids in shooterData) {
          for (res in shooterData[ids].singleCompetition) {
            var playerRes = {
              "Name": shooterData[ids].FirstName + " " + shooterData[ids].LastName,
              "Result": shooterData[ids].singleCompetition[res].results || -100
            }
            resultList.push(playerRes);
          }
        }
        var score = 0;
        var countShots = 0;
        for (item in resultList) {
          // console.log(item);
          if (resultList[item].Result != -100) {
            for (stage in resultList[item].Result) {
              for (shot in resultList[item].Result[stage].Shots) {
                score += parseFloat(resultList[item].Result[stage].Shots[shot].Score);
                countShots++;
              }
            }
            score = score / countShots;
            resultList[item].Result = score;
            resultList[item].Stage = stage;
            score = 0;
            countShots = 0;
          }
        }
        resultList.sort(function (a, b) {
          return parseFloat(b.Result) - parseFloat(a.Result);
        });
        resultNew = [];
        resultList.forEach(function (a) {
          if (!this[a.Name]) {
            this[a.Name] = { Name: a.Name, Result: 0 };
            resultNew.push(this[a.Name]);
          }
          this[a.Name].Result += a.Result;
        }, Object.create(null));


        var tableString = rowStart + "<th>" + "Name" + "</th><th>" + "Score" + "</th><th>" + "Stage ID" + "</th>" + rowEnd;
        for (key in resultList) {
          tableString += rowStart + columnStart + resultList[key].Name + columnEnd +
            columnStart + (parseFloat(resultList[key].Result) == -100 ? "NOT STARTED" : resultList[key].Result.toFixed(2)) + columnEnd +
            columnStart + (resultList[key].Stage == null ? "N/A" : resultList[key].Stage) + columnEnd + rowEnd;
          document.getElementById("leaderboard_div").style.display = "block";
          document.getElementById("leaderboard_table").innerHTML = tableString;
        }
      }
    }

    async function handleFile(e) {
      var files = e.target.files, f = files[0];
      var reader = new FileReader();
      reader.onload = async function (e) {
        var data = new Uint8Array(e.target.result);
        var excelFile = XLS.utils.sheet_to_row_object_array(XLSX.read(data, { type: 'array' }).Sheets['Sheet1']);
        for (key in excelFile) {
          var firstName;
          var lastName;
          var email;
          if (Object.keys(excelFile[key]).length == 3) {
            firstName = excelFile[key]['Meno a Priezvisko'];
            email = excelFile[key]['Email'];
            lastName = firstName.split(" ").slice(1, firstName.length - 1).join(" ");
            firstName = firstName.split(" ")[0];
            await writeUserDataArgs(email, firstName, lastName, 'N/A');

          }

        }
      };
      reader.readAsArrayBuffer(f);
    }

    function editThisUser(userRowId) {
      document.getElementById("");
    }

    function removeUser(shooterID) {
      var user = firebase.auth().currentUser;
      userId = user.uid;
      var refDelete = firebase.database().ref('/users/' + userId + '/competition/shooters/' + shooterID);
      if (confirm("Do you really want to remove this user? (" + shooterID + ")")) {
        refDelete.remove()
          .then(function () {
            console.log("Remove succeeded.");
            editUsers();
          })
          .catch(function (error) {
            console.log("Remove failed: " + error.message);
            customAlert("Remove failed", "red");
          });
      }

    }

    function openForm() {
      document.getElementById("loginPopup").style.display = "block";
    }

    function openRegisterForm() {
      document.getElementById("registerPopup").style.display = "block";
    }

    function closeForm() {
      document.getElementById("loginPopup").style.display = "none";
      document.getElementById("email").value = "";
      document.getElementById("first_name").value = "";
      document.getElementById("last_name").value = "";
      document.getElementById("phone_number").value = "";
      document.getElementById("registerPopup").style.display = "none";
      document.getElementById("user_registration_email").value = "";
      document.getElementById("user_registration_password").value = "";
      document.getElementById("register_form_nick_div").style.display = "none";
      document.getElementById("user_registration_nick").value = "";
      document.getElementById("user_registration_last_name").value = "";
      document.getElementById("user_registration_first_name").value = "";
    }

    async function writeCompetitionData(competition, shooters) {
      var user = firebase.auth().currentUser;
      userId = user.uid;
      var nextIndex = 0;
      var tempData;
      loadingCursorOn();
      await firebase.database().ref('/users/' + userId + '/competition').once('value').then(function (snapshot) {
        tempData = snapshot.val();
        // nextIndex = Object.keys(tempData).length + 1;
        nextIndex = Math.max.apply(null, Object.keys(tempData.competitions)) + 1;
        console.log("Continuing with index: " + nextIndex);
        var newUser = firebase.database().ref('users/' + userId + '/competition/shooters/' + nextIndex);
        console.log(email + firstName + lastName + phoneNumber);
        newUser.set({
          Email: email,
          FirstName: firstName,
          ID: nextIndex,
          LastName: lastName,
          PhoneNumber: phoneNumber
        }, function (error) {
          if (error) {
            console.log(error);
          } else {
            console.log("SUCCESSFULLY ADDED");
            firebase.database().ref('/users/' + userId).once('value').then(function (snapshot) {
              userData = snapshot.val();
              editUsers();
            });
          }
        });
      });
      loadingCursorOff();
    }

    async function writeUserDataArgs(email, firstName, lastName, phoneNumber) {
      var user = firebase.auth().currentUser;
      userId = user.uid;
      var nextIndex = 0;
      var tempData;
      loadingCursorOn();
      await firebase.database().ref('/users/' + userId + '/competition/shooters').once('value').then(function (snapshot) {
        tempData = snapshot.val();
        // nextIndex = Object.keys(tempData).length + 1;
        var keys = Object.keys(tempData);
        nextIndex = parseInt(keys[keys.length - 1]) + 1;
        console.log("Continuing with index: " + nextIndex);
        var newUser = firebase.database().ref('users/' + userId + '/competition/shooters/' + nextIndex);
        console.log(email + firstName + lastName + phoneNumber);
        newUser.set({
          Email: email,
          FirstName: firstName,
          ID: nextIndex,
          LastName: lastName,
          PhoneNumber: phoneNumber
        }, function (error) {
          if (error) {
            console.log(error);
          } else {
            console.log("SUCCESSFULLY ADDED");
            firebase.database().ref('/users/' + userId).once('value').then(function (snapshot) {
              userData = snapshot.val();
              editUsers();
            });
          }
        });
      });
      loadingCursorOff();
    }

    function writeUserData() {
      var user = firebase.auth().currentUser;
      userId = user.uid;
      var nextIndex = 0;
      var tempData;
      firebase.database().ref('/users/' + userId + '/competition/shooters').once('value').then(function (snapshot) {
        tempData = snapshot.val();
        let _email = document.getElementById("email").value;
        let _firstName = document.getElementById("first_name").value;
        let _lastName = document.getElementById("last_name").value;
        let _phoneNumber = document.getElementById("phone_number").value;
        // nextIndex = Object.keys(tempData).length + 1;
        var keys = Object.keys(tempData);
        nextIndex = parseInt(keys[keys.length - 1]) + 1;
        // console.log("Continuing with next index: " + nextIndex);

        var newUser = firebase.database().ref('users/' + userId + '/competition/shooters/' + nextIndex);
        newUser.set({
          Email: _email,
          FirstName: _firstName,
          ID: nextIndex,
          LastName: _lastName,
          PhoneNumber: _phoneNumber
        }, function (error) {
          if (error) {
            console.log(error);
          } else {
            console.log("SUCCESSFULLY ADDED");
            firebase.database().ref('/users/' + userId).once('value').then(function (snapshot) {
              userData = snapshot.val();
              editUsers();
              closeForm();
            });
          }
        });

      }, function (error) {

        if (error) {
          // console.log(error);
        }
        else { }
      });
      // console.log(tempData);
      for (value in tempData) {
        nextIndex++;
      }
    }

    function removeCompetitionData() {
      var user = firebase.auth().currentUser;
      userId = user.uid;
      var refDelete = firebase.database().ref('/users/' + userId + '/competition');
      if (confirm("Do you really want to remove all competition data?")) {
        refDelete.remove()
          .then(function () {
            console.log("Competition removed successfully.");
            document.getElementById("competition_div").style.display = "none";
            document.getElementById("cleaderboard_table").style.display = "none";
          })
          .catch(function (error) {
            console.log("Competition removal failed: " + error.message);
            customAlert("Removal failed", "red");
          });
      }

    }

    function customAlert(text, backgroundColor) {
      document.getElementById("alert_text").innerHTML = text;
      var alertElement = document.getElementById("alert");
      alertElement.style.backgroundColor = backgroundColor;
      alertElement.style.display = "block";
      fadeOut(alertElement);
    }
    function fadeOut(element) {
      if (element.value != 'fading') {
        var op = 1;  // initial opacity
        element.value = 'fading';
        var timer = setInterval(function () {
          if (op <= 0.03) {
            clearInterval(timer);
            element.style.display = 'none';
            element.style.opacity = '1';
            element.value = '';
          }
          element.style.opacity = op;
          element.style.filter = 'alpha(opacity=' + op * 100 + ")";
          op -= op * 1 / op * 1 / op * 1 / op * 0.01;
        }, 50);
      }
    }

    function backButton() {
      document.getElementById("back_button").style.display = "none";
      parseCompetitionData(userData);
      document.getElementById("leaderboard_div").style.display = "none";
      document.getElementById("game_setup_div").style.display = "none";
    }

    function homeButton() {
      document.getElementsByTagName("body")[0].style.overflow = "initial";
      document.getElementById("user_div").style.display = "block";
      document.getElementById("navbar").classList.remove("invisible-children");
      document.getElementById("competition_div").style.display = "none";
      document.getElementById("leaderboard_div").style.display = "none";
      document.getElementById("game_setup_div").style.display = "none";
      document.getElementById("login_div").style.display = "none";
      document.getElementById("multiplayer_setup_div").style.display = "none";
      document.getElementById("multiplayer_table_div").style.display = "none";
      document.getElementById("footer").style.display = "none";
    }

    function logout() {
      document.getElementById("navbar").style.display = "none";
      document.getElementById("navbar").classList.remove("invisible-children");
      document.getElementById("competition_div").style.display = "none";
      document.getElementById("leaderboard_div").style.display = "none";
      document.getElementById("game_setup_div").style.display = "none";
      document.getElementById("multiplayer_setup_div").style.display = "none";
      document.getElementById("multiplayer_table_div").style.display = "none";
      document.getElementById("footer").style.display = "none";

      firebase.auth().signOut();
    }
  </script>

</body>

</html>